<!DOCTYPE html>
<html>
<head>
    <title>Email List</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Emails</h1>
    <table>
        <thead>
            <tr>
                <th>Subject</th>
                <th>Date Sent</th>
                <th>Date Received</th>
                <th>Body</th>
                <th>Attachments</th>
            </tr>
        </thead>
        <tbody id="email-list">
        </tbody>
    </table>
    <script>
        $(document).ready(function() {
            $.getJSON('/api/fetch-emails/')
            $.getJSON('/api/emails-list/', function(data) {
                if (data) {
                    var rows = '';
                    data.forEach(function(email) {
                        var attachments = email.attachments.map(a => a.name).join(", ");
                        rows += '<tr><td>' + email.subject + '</td><td>' + email.date_sent + '</td><td>' + email.date_received + '</td><td>' + email.body + '</td><td>' + attachments + '</td></tr>';
                    });
                    $('#email-list').html(rows);
                }
            });

            var emailSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/emails/',
                'echo-protocol'
            );

            emailSocket.onerror = function(e) {
                console.log(e);
            };

            emailSocket.onmessage = function(e) {
                var data = JSON.parse(e.data);
                var email = data.message;
                var attachments = email.attachments.map(a => a.name).join(", ");
                var row = '<tr><td>' + email.subject + '</td><td>' + email.date_sent + '</td><td>' + email.date_received + '</td><td>' + email.body + '</td><td>' + attachments + '</td></tr>';
                $('#email-list').prepend(row);
            };

            emailSocket.onclose = function(e) {
                console.error('Email socket closed unexpectedly');
            };
        });
    </script>
</body>
</html>